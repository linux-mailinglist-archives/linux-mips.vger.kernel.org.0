Return-Path: <linux-mips-owner@vger.kernel.org>
X-Original-To: lists+linux-mips@lfdr.de
Delivered-To: lists+linux-mips@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 5A9FF567F80
	for <lists+linux-mips@lfdr.de>; Wed,  6 Jul 2022 09:06:05 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231414AbiGFHGB (ORCPT <rfc822;lists+linux-mips@lfdr.de>);
        Wed, 6 Jul 2022 03:06:01 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58644 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231368AbiGFHFh (ORCPT
        <rfc822;linux-mips@vger.kernel.org>); Wed, 6 Jul 2022 03:05:37 -0400
Received: from ams.source.kernel.org (ams.source.kernel.org [145.40.68.75])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3B997222A5;
        Wed,  6 Jul 2022 00:05:36 -0700 (PDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by ams.source.kernel.org (Postfix) with ESMTPS id ECDB9B81AE8;
        Wed,  6 Jul 2022 07:05:34 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id A59F6C3411C;
        Wed,  6 Jul 2022 07:05:33 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1657091133;
        bh=oQFTV82o01nns7iJnvxF0Gz1JyoZvICeGttjRj2CI+A=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=oElfMAsGtjX9+8EiwskrKtK8LY95zSBUNn5vU0cEBJs6C6orPDv3QLWLJoKFLMmQ3
         DGidFNb84VGisgtn/wc3a1KMc96cfZspoN/V3kS9Md870MJaW8zxFZ5+QzdGda+ct3
         h1b+R9IH3qW0jHrwgGeGsqFDbb99ImDdFHIut9/XJjbfz23qGaPJmHnfPdFMH97hDW
         LZFYTeUJBg6ABG5+xK+/hcWetpY+/69PGfObCzkXpTBt6ldf+RJ3WWZXNNnYjUsecy
         m1EgK6bHlgMzJRkQH8cIgS0aeyZ4hPgZmzeifZkaZnhwfmPIfdt8tIy5241NGlBkCG
         yTuiBmF8j2KIA==
Received: from ip-185-104-136-29.ptr.icomera.net ([185.104.136.29] helo=wait-a-minute.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.95)
        (envelope-from <maz@kernel.org>)
        id 1o8z6J-005YIB-HU;
        Wed, 06 Jul 2022 08:05:31 +0100
Date:   Wed, 06 Jul 2022 08:05:30 +0100
Message-ID: <87fsjen2kl.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Sander Vanheule <sander@svanheule.net>
Cc:     Aleksander Jan Bajkowski <olek2@wp.pl>, tsbogend@alpha.franken.de,
        martin.blumenstingl@googlemail.com, hauke@hauke-m.de,
        git@birger-koblitz.de, linux-mips@vger.kernel.org,
        linux-kernel@vger.kernel.org
Subject: Re: [PATCH] MIPS: smp-mt: enable all hardware interrupts on second VPE
In-Reply-To: <3c9a032edd0fb9b9608ad3ca08d6e3cc38f21464.camel@svanheule.net>
References: <20220702190705.5319-1-olek2@wp.pl>
        <3c9a032edd0fb9b9608ad3ca08d6e3cc38f21464.camel@svanheule.net>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.104.136.29
X-SA-Exim-Rcpt-To: sander@svanheule.net, olek2@wp.pl, tsbogend@alpha.franken.de, martin.blumenstingl@googlemail.com, hauke@hauke-m.de, git@birger-koblitz.de, linux-mips@vger.kernel.org, linux-kernel@vger.kernel.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
X-Spam-Status: No, score=-7.8 required=5.0 tests=BAYES_00,DKIMWL_WL_HIGH,
        DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_HI,
        SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE autolearn=ham
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-mips.vger.kernel.org>
X-Mailing-List: linux-mips@vger.kernel.org

On Sun, 03 Jul 2022 19:15:11 +0100,
Sander Vanheule <sander@svanheule.net> wrote:
> 
> Hi Aleksander,
> 
> Since this is IRQ related: +CC Marc Zyngier
> 
> On Sat, 2022-07-02 at 21:07 +0200, Aleksander Jan Bajkowski wrote:
> > This patch is needed to handle interrupts by the second VPE on
> > the Lantiq xRX200, xRX300 and xRX330 SoCs. In these chips, 32 ICU
> > interrupts are connected to each hardware line. The SoC supports
> > a total of 160 interrupts. Currently changing smp_affinity to the
> > second VPE hangs interrupts.
> > 
> > This problem affects multithreaded SoCs with a custom interrupt
> > controller. Chips with 1004Kc core and newer use the MIPS GIC.
> > 
> > Also CC'ed Birger Koblitz and Sander Vanheule. Both are working
> > on support for Realtek RTL930x chips with 34Kc core and Birger
> > has added a patch in OpenWRT that also enables all interrupt
> > lines. So it looks like this patch is useful for more SoCs.
> > 
> > Tested on lantiq xRX200 and xRX330.
> > 
> > Signed-off-by: Aleksander Jan Bajkowski <olek2@wp.pl>
> 
> Thanks for bringing up this issue. Like you say OpenWrt carries a
> similar patch, and I also carry a patch on my tree to enable all CPU
> IRQ lines.
> 
> Indiscriminately enabling all IRQ lines doesn't sit quite right with
> me though, since I would expect these to be enabled
> on-demand. I.e. when a peripheral requests an IRQ, or when an IRQ
> controller is cascaded into one of the CPU's interrupt lines. If I
> understand correctly, the IRQ mask/unmask functions in
> drivers/irqchip/irq-mips-cpu.c should do this.

But this is only enabling interrupts at the CPU level, right? And the
irqchip is still in control of the masking of the individual
interrupts?

If both assertions are true, then this patch seems OK. If it just let
any interrupt through without any control, then this is wrong.

So which one is it?

	M.

-- 
Without deviation from the norm, progress is not possible.
