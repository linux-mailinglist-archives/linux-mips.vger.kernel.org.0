Return-Path: <linux-mips-owner@vger.kernel.org>
X-Original-To: lists+linux-mips@lfdr.de
Delivered-To: lists+linux-mips@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id E923C272385
	for <lists+linux-mips@lfdr.de>; Mon, 21 Sep 2020 14:16:08 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726444AbgIUMQI (ORCPT <rfc822;lists+linux-mips@lfdr.de>);
        Mon, 21 Sep 2020 08:16:08 -0400
Received: from elvis.franken.de ([193.175.24.41]:49018 "EHLO elvis.franken.de"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726341AbgIUMQI (ORCPT <rfc822;linux-mips@vger.kernel.org>);
        Mon, 21 Sep 2020 08:16:08 -0400
Received: from uucp (helo=alpha)
        by elvis.franken.de with local-bsmtp (Exim 3.36 #1)
        id 1kKKjj-0004Bw-00; Mon, 21 Sep 2020 14:16:03 +0200
Received: by alpha.franken.de (Postfix, from userid 1000)
        id D4B22C0FE0; Mon, 21 Sep 2020 14:15:54 +0200 (CEST)
Date:   Mon, 21 Sep 2020 14:15:54 +0200
From:   Thomas Bogendoerfer <tsbogend@alpha.franken.de>
To:     Huacai Chen <chenhc@lemote.com>
Cc:     linux-mips@vger.kernel.org, Fuxin Zhang <zhangfx@lemote.com>,
        Huacai Chen <chenhuacai@gmail.com>,
        Jiaxun Yang <jiaxun.yang@flygoat.com>
Subject: Re: [PATCH V7 2/3] MIPS: Loongson-3: Enable COP2 usage in kernel
Message-ID: <20200921121554.GA8642@alpha.franken.de>
References: <1600679548-29154-1-git-send-email-chenhc@lemote.com>
 <1600679548-29154-2-git-send-email-chenhc@lemote.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <1600679548-29154-2-git-send-email-chenhc@lemote.com>
User-Agent: Mutt/1.5.23 (2014-03-12)
Precedence: bulk
List-ID: <linux-mips.vger.kernel.org>
X-Mailing-List: linux-mips@vger.kernel.org

On Mon, Sep 21, 2020 at 05:12:27PM +0800, Huacai Chen wrote:
> Loongson-3's COP2 is Multi-Media coprocessor, it is disabled in kernel
> mode by default. However, gslq/gssq (16-bytes load/store instructions)
> overrides the instruction format of lwc2/swc2. If we wan't to use gslq/
> gssq for optimization in kernel, we should enable COP2 usage in kernel.
> 
> Please pay attention that in this patch we only enable COP2 in kernel,
> which means it will lose ST0_CU2 when a process go to user space (try
> to use COP2 in user space will trigger an exception and then grab COP2,
> which is similar to FPU). And as a result, we need to modify the context
> switching code because the new scheduled process doesn't contain ST0_CU2
> in its THERAD_STATUS probably.
> 
> For zboot, we disable gslq/gssq be generated by toolchain.
> 
> Signed-off-by: Huacai Chen <chenhc@lemote.com>
> ---
> V3: Stop using ST0_MM and use ST0_CU2 instead (Thank Thomas and Maciej).
> V4: Adopt Thomas's suggestion to improve coding style.
> V5: Use ST0_KERNEL_CUMASK in all possible places to avoid #ifdefs.
> V6: Modify switch_to() and don't touch r4k_switch.S.
> V7: For zboot, disable gslq/gssq be generated by toolchain.
> 
>  arch/mips/boot/compressed/Makefile | 5 +++++
>  arch/mips/include/asm/mipsregs.h   | 7 +++++++
>  arch/mips/include/asm/stackframe.h | 6 +++---
>  arch/mips/kernel/head.S            | 2 +-
>  arch/mips/kernel/process.c         | 4 ++--
>  arch/mips/kernel/traps.c           | 2 +-
>  6 files changed, 19 insertions(+), 7 deletions(-)
> 
> diff --git a/arch/mips/boot/compressed/Makefile b/arch/mips/boot/compressed/Makefile
> index 9a9ba77..2c491c1 100644
> --- a/arch/mips/boot/compressed/Makefile
> +++ b/arch/mips/boot/compressed/Makefile
> @@ -22,6 +22,11 @@ KBUILD_CFLAGS := $(filter-out -pg, $(KBUILD_CFLAGS))
>  
>  KBUILD_CFLAGS := $(filter-out -fstack-protector, $(KBUILD_CFLAGS))
>  
> +# Disable lq/sq in zboot
> +ifdef CONFIG_CPU_LOONGSON64
> +KBUILD_CFLAGS := $(filter-out -march=loongson3a, $(KBUILD_CFLAGS)) -march=mips64r2
> +endif
> +

thanks for doing this, I'm going to apply this later.

This remind of another question, what about loongson2ef ? I'm getting
kbuild failure because of enabled loongson-mmi mails. Are we are missing
something like cflags-y += $(call cc-option,-mno-loongson-mmi) in Platform
file ? Who is taking care of loongson2ef ?

Thomas.

-- 
Crap can work. Given enough thrust pigs will fly, but it's not necessarily a
good idea.                                                [ RFC1925, 2.3 ]
